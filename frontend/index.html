<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Smart Shift Scheduler</title>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; max-width: 1100px; margin: 0 auto; padding: 20px; background-color: #f4f4f9; color: #333; }
        .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1, h2 { margin-top: 0; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="date"], input[type="number"], select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background 0.3s; }
        button:hover { background-color: #0056b3; }
        button.delete-btn { background-color: #dc3545; padding: 2px 8px; font-size: 12px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f8f9fa; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; color: white; }
        .badge-leader { background-color: #28a745; }
        .badge-staff { background-color: #6c757d; }
        
        #calendar { max-width: 1000px; margin: 0 auto; min-height: 700px; }
        .cost-panel { background-color: #28a745; color: white; padding: 15px; border-radius: 8px; text-align: right; font-size: 1.2em; font-weight: bold; margin-bottom: 10px; }
        
        /* å¸Œæœ›ä¼‘ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .fc-event.request-ng { background-color: #dc3545 !important; border-color: #dc3545 !important; opacity: 0.8; }
    </style>
</head>
<body>
    <h1>ğŸ“… Smart Shift Scheduler <small>(Lv.2)</small></h1>

    <div class="card">
        <h2>1. ã‚¹ã‚¿ãƒƒãƒ•ç™»éŒ²</h2>
        <div class="form-group">
            <input type="text" id="staffName" placeholder="åå‰" style="width: 100px;">
            <input type="number" id="staffWage" placeholder="æ™‚çµ¦" value="1000" style="width: 80px;">
            
            <input type="text" id="staffRoles" placeholder="å½¹å‰² (ä¾‹: ã‚­ãƒƒãƒãƒ³,ç· ã‚ä½œæ¥­)" style="width: 200px;">
            
            
            
            <label style="display:inline; margin-left: 10px;"><input type="checkbox" id="isLeader"> ãƒªãƒ¼ãƒ€ãƒ¼</label>
            <button onclick="addStaff()" style="margin-left: 10px;">ç™»éŒ²</button>
        </div>
        <details>
            <summary style="cursor:pointer; color:#007bff;">ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§</summary>
            <table id="staffTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>åå‰</th>
                        <th>æ™‚çµ¦</th>
                        <th>å½¹å‰²ãƒ»æ¨©é™</th> <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </details>
    </div>

    <div class="card" style="border-left: 5px solid #dc3545;">
        <h2>2. å¸Œæœ›ä¼‘ (NGæ—¥) ã®ç™»éŒ²</h2>
        <p><small>â€»ã“ã“ã§ç™»éŒ²ã—ãŸæ—¥ã¯ã€AIãŒã‚·ãƒ•ãƒˆã‚’å…¥ã‚Œãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚</small></p>
        <div class="form-group">
            <label>èª°ãŒï¼Ÿ</label>
            <select id="requestStaffSelect"></select> <label>ã„ã¤ä¼‘ã‚€ï¼Ÿ</label>
            <input type="date" id="requestDate">
            
            <button onclick="addRequest()" style="background-color: #dc3545; margin-top: 10px;">ä¼‘ã¿ã‚’ç™»éŒ²</button>
        </div>
    </div>

    <div class="card">
        <h2>3. ã‚·ãƒ•ãƒˆä½œæˆè¨­å®š & ãƒ«ãƒ¼ãƒ«</h2>
        
        <div style="background: #e9ecef; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
            <label>å¿…é ˆãƒ«ãƒ¼ãƒ«ã®è¿½åŠ :</label>
            <div style="display: flex; gap: 10px; align-items: center;">
                <select id="ruleRole" style="width: 150px;">
    <option value="">å½¹å‰²ã‚’é¸æŠ...</option>
</select>
                <input type="number" id="ruleCount" value="1" style="width: 50px;">
                <span>äººä»¥ä¸Š/ã‚·ãƒ•ãƒˆ</span>
                <button onclick="addRule()" style="padding: 5px 10px; font-size: 14px;">è¿½åŠ </button>
            </div>
            <ul id="ruleList" style="list-style: none; padding: 0; margin-top: 10px;"></ul>
        </div>

        <div class="form-group">
            <label>ã‚·ãƒ•ãƒˆé–‹å§‹æ—¥: <input type="date" id="startDate"></label>
            <button onclick="generateShift()">AIã§ã‚·ãƒ•ãƒˆã‚’ç”Ÿæˆãƒ»ä¿å­˜</button>
        </div>
    </div>
    <div class="card">
        <div class="cost-panel">äººä»¶è²»: <span id="totalCost">Â¥0</span></div>
        <div id="calendar"></div>
    </div>

    <script>
        const API_URL = "http://localhost:8080/api";
        let calendar;
        let staffMap = {}; 
        
        // â˜…è¿½åŠ : ãƒ«ãƒ¼ãƒ«ç®¡ç†ç”¨ã®å¤‰æ•°
        let activeRules = []; 

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('startDate').valueAsDate = new Date();
            document.getElementById('requestDate').valueAsDate = new Date();
            
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'ja',
                editable: true,  
                droppable: true,
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,listMonth' },
                events: [],

                eventDrop: async function(info) {
                    if (info.event.extendedProps.type === 'request') {
                        alert("å¸Œæœ›ä¼‘ã¯ç§»å‹•ã§ãã¾ã›ã‚“ã€‚ä¸€åº¦å‰Šé™¤ã—ã¦ç™»éŒ²ã—ç›´ã—ã¦ãã ã•ã„ã€‚");
                        info.revert(); return;
                    }
                    
                    const shiftId = info.event.id;
                    const newDate = info.event.startStr;
                    const staffId = info.event.extendedProps.staffId;

                    const isDuplicate = calendar.getEvents().some(evt => 
                        evt.id !== info.event.id && evt.startStr === newDate && evt.extendedProps.staffId === staffId
                    );
                    if (isDuplicate) {
                        alert("ãã®æ—¥ã«ã¯æ—¢ã«æœ¬äººãŒã„ã¾ã™ï¼");
                        info.revert(); return;
                    }

                    if (!confirm(`${info.event.title} ã‚’ ${newDate} ã«ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ`)) {
                        info.revert(); return;
                    }

                    try {
                        const res = await fetch(`${API_URL}/shift/${shiftId}`, {
                            method: "PUT",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ date: newDate })
                        });
                        if (!res.ok) throw new Error("ä¿å­˜å¤±æ•—");
                        calculateTotalCost();
                    } catch (e) { alert(e); info.revert(); }
                },

                eventClick: async function(info) {
                    const type = info.event.extendedProps.type;
                    const msg = type === 'request' ? "ã“ã®å¸Œæœ›ä¼‘ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ" : "ã“ã®ã‚·ãƒ•ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ";
                    
                    if (confirm(msg)) {
                        try {
                            const endpoint = type === 'request' ? 'request' : 'shift';
                            const res = await fetch(`${API_URL}/${endpoint}/${info.event.id}`, { method: "DELETE" });
                            if (!res.ok) throw new Error("å‰Šé™¤å¤±æ•—");
                            info.event.remove();
                            calculateTotalCost();
                        } catch (e) { alert(e); }
                    }
                },
                datesSet: function() { calculateTotalCost(); }
            });
            calendar.render();
            initData();
        });

        async function initData() {
            await loadStaff();          
            await loadExistingShifts(); 
            await loadRequests();
        }

        async function loadStaff() {
            try {
                const res = await fetch(`${API_URL}/staff`);
                const staffList = await res.json();
                staffMap = {};
                
                const tbody = document.querySelector("#staffTable tbody");
                const staffSelect = document.getElementById("requestStaffSelect");
                
                // â˜…å½¹å‰²é¸æŠç”¨ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’å–å¾—
                const roleSelect = document.getElementById("ruleRole");
                
                tbody.innerHTML = "";
                staffSelect.innerHTML = ""; 
                
                // â˜…ã“ã‚Œã¾ã§ã®é¸æŠè‚¢ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆæœ€åˆã®1å€‹ã ã‘æ®‹ã™ï¼‰
                roleSelect.innerHTML = '<option value="">å½¹å‰²ã‚’é¸æŠ...</option>';

                // â˜…å…¨ã‚¹ã‚¿ãƒƒãƒ•ã®å½¹å‰²ã‚’é›†ã‚ã‚‹ãŸã‚ã®ã€Œé‡è¤‡ãªã—ãƒªã‚¹ãƒˆ(Set)ã€ã‚’ä½œã‚‹
                const allRoles = new Set();

                staffList.forEach(s => {
                    staffMap[s.id] = { name: s.name, wage: s.hourly_wage || 0 };
                    
                    let rolesHtml = "";
                    if (s.roles) {
                        // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã‚’åˆ†è§£ã—ã¦ãƒªã‚¹ãƒˆã«è¿½åŠ 
                        const roles = s.roles.split(',');
                        roles.forEach(r => {
                            const roleName = r.trim();
                            if(roleName) allRoles.add(roleName); // â˜…ãƒªã‚¹ãƒˆã«è¿½åŠ 
                            
                            rolesHtml += `<span class="badge" style="background-color: #17a2b8; margin-right:2px;">${roleName}</span>`;
                        });
                    }

                    const badge = s.is_leader ? '<span class="badge badge-leader">Leader</span>' : '<span class="badge badge-staff">Staff</span>';
                    
                    tbody.innerHTML += `<tr>
                        <td>${s.id}</td>
                        <td>${s.name}</td>
                        <td>Â¥${s.hourly_wage}</td>
                        <td>${rolesHtml} ${badge}</td>
                        <td><button class="delete-btn" onclick="deleteStaff(${s.id})">å‰Šé™¤</button></td>
                    </tr>`;
                    
                    const option = document.createElement("option");
                    option.value = s.id;
                    option.text = `${s.name} (ID:${s.id})`;
                    staffSelect.appendChild(option);
                });

                // â˜…é›†ã‚ãŸå½¹å‰²ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«è¿½åŠ ã™ã‚‹
                allRoles.forEach(role => {
                    const option = document.createElement("option");
                    option.value = role;
                    option.text = role;
                    roleSelect.appendChild(option);
                });

            } catch(e) { console.error(e); }
        }

        // â˜…è¿½åŠ : ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
        function addRule() {
            const role = document.getElementById("ruleRole").value;
            const count = parseInt(document.getElementById("ruleCount").value);
            
            if(!role || count <= 0) return alert("å½¹å‰²åã¨äººæ•°ã‚’æ­£ã—ãå…¥ã‚Œã¦ãã ã•ã„");
            
            activeRules.push({ role, count });
            renderRules();
            
            document.getElementById("ruleRole").value = ""; 
        }

        // â˜…è¿½åŠ : ãƒ«ãƒ¼ãƒ«ä¸€è¦§ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function renderRules() {
            const list = document.getElementById("ruleList");
            list.innerHTML = "";
            activeRules.forEach((r, index) => {
                const li = document.createElement("li");
                li.style.marginBottom = "5px";
                li.innerHTML = `
                    <span class="badge" style="background-color: #6f42c1;">${r.role}</span> ãŒ
                    <b>${r.count}</b> äººä»¥ä¸Š 
                    <button onclick="removeRule(${index})" style="margin-left:5px; padding:2px 5px; background:#dc3545; font-size:12px;">Ã—</button>
                `;
                list.appendChild(li);
            });
        }

        // â˜…è¿½åŠ : ãƒ«ãƒ¼ãƒ«ã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°
        function removeRule(index) {
            activeRules.splice(index, 1);
            renderRules();
        }

        async function loadExistingShifts() {
            try {
                const res = await fetch(`${API_URL}/shift`);
                if (!res.ok) return;
                const shifts = await res.json();
                const events = shifts.map(s => {
                    const staffInfo = staffMap[s.staff_id] || { name: `ID:${s.staff_id}`, wage: 0 };
                    let title = `${staffInfo.name} `; 
                    let color = s.shift_type === 1 ? "#3788d8" : "#28a745";
                    let suffix = s.shift_type === 1 ? "æ—©" : "é…";
                    
                    return {
                        id: s.id, title: title + suffix, start: s.date, color: color,
                        extendedProps: { type: 'shift', staffId: s.staff_id, wage: staffInfo.wage, hours: 8 }
                    };
                });
                calendar.removeAllEvents(); 
                calendar.addEventSource(events);
            } catch (e) { console.error(e); }
        }

        async function loadRequests() {
            try {
                const res = await fetch(`${API_URL}/request`);
                if (!res.ok) return;
                const reqs = await res.json();
                
                const events = reqs.map(r => {
                    const staffInfo = staffMap[r.staff_id] || { name: `ID:${r.staff_id}` };
                    return {
                        id: r.id,
                        title: `âœ• ${staffInfo.name}`,
                        start: r.date,
                        className: 'request-ng',
                        display: 'background',
                        color: '#dc3545',
                        extendedProps: { type: 'request', staffId: r.staff_id, wage: 0, hours: 0 }
                    };
                });
                calendar.addEventSource(events);
            } catch (e) { console.error(e); }
        }

        async function addRequest() {
            const staffId = document.getElementById("requestStaffSelect").value;
            const date = document.getElementById("requestDate").value;
            
            if(!staffId || !date) return alert("ã‚¹ã‚¿ãƒƒãƒ•ã¨æ—¥ä»˜ã‚’é¸ã‚“ã§ãã ã•ã„");

            try {
                const res = await fetch(`${API_URL}/request`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ staff_id: parseInt(staffId), date: date })
                });
                if(res.ok) {
                    alert("å¸Œæœ›ä¼‘ã‚’ç™»éŒ²ã—ã¾ã—ãŸ");
                    calendar.removeAllEvents();
                    await loadExistingShifts();
                    await loadRequests();
                } else {
                    alert("ç™»éŒ²å¤±æ•—");
                }
            } catch(e) { alert(e); }
        }

        async function deleteStaff(id) {
            if(!confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            await fetch(`${API_URL}/staff/${id}`, { method: "DELETE" });
            initData();
        }

        function calculateTotalCost() {
            const events = calendar.getEvents();
            let total = 0;
            events.forEach(evt => {
                const wage = evt.extendedProps.wage || 0;
                const hours = evt.extendedProps.hours || 0;
                total += wage * hours;
            });
            document.getElementById("totalCost").innerText = "Â¥" + total.toLocaleString();
        }

        async function addStaff() {
            const name = document.getElementById("staffName").value;
            const wage = document.getElementById("staffWage").value;
            const roles = document.getElementById("staffRoles").value; 
            const isLeader = document.getElementById("isLeader").checked;
            
            if(!name) return alert("åå‰ã‚’å…¥ã‚Œã¦ãã ã•ã„");

            await fetch(`${API_URL}/staff`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    name, 
                    is_leader: isLeader, 
                    hourly_wage: parseInt(wage),
                    roles: roles
                })
            });
            
            document.getElementById("staffName").value = "";
            document.getElementById("staffRoles").value = ""; 
            initData(); 
        }

        // â˜…æ›´æ–°: ãƒ«ãƒ¼ãƒ«(activeRules)ã‚’é€ä¿¡ã™ã‚‹ã‚ˆã†ã«æ›¸ãæ›ãˆ
        async function generateShift() {
            const startDateStr = document.getElementById("startDate").value;
            if(!startDateStr) return alert("é–‹å§‹æ—¥ã‚’é¸ã‚“ã§ãã ã•ã„");

            const reqBody = { 
                start_date: startDateStr, 
                days: 30, 
                requests: [], 
                role_constraints: activeRules // â˜…ã“ã“ãŒé‡è¦ï¼
            };

            alert("AIãŒè¨ˆç®—ãƒ»ä¿å­˜ä¸­ã§ã™...");
            try {
                const res = await fetch(`${API_URL}/shift`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(reqBody)
                });
                const data = await res.json();
                if(res.ok) {
                    calendar.removeAllEvents();
                    await loadExistingShifts(); 
                    await loadRequests();
                    alert(data.message);
                } else { alert("ã‚¨ãƒ©ãƒ¼: " + JSON.stringify(data)); }
            } catch (e) { alert("ã‚¨ãƒ©ãƒ¼: " + e); }
        }
    </script>
</body>
</html>