<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Shift Scheduler | AIシフト管理</title>
    
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #50e3c2;
            --danger-color: #e74c3c;
            --dark-bg: #f0f2f5;
            --text-color: #333;
            --sidebar-width: 380px;
        }

        body { 
            font-family: 'Noto Sans JP', sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: var(--dark-bg); 
            color: var(--text-color); 
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ヘッダー */
        header {
            background-color: #fff;
            padding: 15px 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }
        header h1 { margin: 0; font-size: 1.5rem; color: #2c3e50; display: flex; align-items: center; gap: 10px; }
        header .subtitle { font-size: 0.9rem; color: #7f8c8d; font-weight: normal; margin-left: 15px; }

        /* レイアウト */
        .container { 
            display: flex; 
            flex: 1;
            overflow: hidden; /* スクロールは内部でさせる */
        }

        /* サイドバー */
        .sidebar { 
            width: var(--sidebar-width); 
            background: #fff; 
            border-right: 1px solid #e1e4e8;
            padding: 20px; 
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.02);
        }

        /* メインコンテンツ */
        .main-content { 
            flex: 1; 
            padding: 20px; 
            overflow-y: auto;
        }

        /* カードデザイン */
        .card { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            border: 1px solid #e1e4e8;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            transition: transform 0.2s;
        }
        
        .sidebar .card {
            padding: 15px;
            border-left: 4px solid var(--primary-color); /* アクセント */
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        h2 { 
            font-size: 1rem; 
            margin-top: 0; 
            margin-bottom: 15px; 
            color: #555; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* 入力フォーム */
        label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.85rem; color: #666; }
        input, select { 
            margin-bottom: 10px; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            width: 100%; 
            box-sizing: border-box; 
            font-size: 0.9rem;
            transition: border 0.2s;
            background: #f9f9f9;
        }
        input:focus, select:focus { 
            outline: none; 
            border-color: var(--primary-color); 
            background: #fff;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1); 
        }

        /* ボタン */
        button { 
            padding: 10px 15px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.2s; 
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .btn-primary { background-color: var(--primary-color); color: white; width: 100%; }
        .btn-primary:hover { background-color: #357abd; transform: translateY(-1px); }
        
        .btn-danger { background-color: var(--danger-color); color: white; width: 100%; }
        .btn-danger:hover { background-color: #c0392b; }

        .btn-success { background-color: #2ecc71; color: white; }
        .btn-success:hover { background-color: #27ae60; }
        
        .btn-secondary { background-color: #95a5a6; color: white; }
        
        .btn-icon { background: none; color: #999; padding: 5px; width: auto; }
        .btn-icon:hover { color: var(--danger-color); background: none; transform: scale(1.1); }

        /* テーブル */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; padding: 8px; color: #888; font-weight: normal; border-bottom: 1px solid #eee; }
        td { padding: 8px; border-bottom: 1px solid #f5f5f5; }
        tr:last-child td { border-bottom: none; }

        /* バッジ */
        .badge { padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; display: inline-block; margin-right: 3px; }
        .badge-role { background: #e1f5fe; color: #0288d1; border: 1px solid #b3e5fc; }
        .badge-leader { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .badge-staff { background: #f5f5f5; color: #616161; border: 1px solid #e0e0e0; }

        /* ルールボックス */
        .rule-box { 
            background: #f8f9fa; 
            padding: 12px; 
            border-radius: 8px; 
            margin-bottom: 10px; 
            border: 1px dashed #ced4da;
        }
        .rule-list li {
            background: white;
            padding: 6px 10px;
            border-radius: 4px;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            font-size: 0.85rem;
        }

        /* カレンダー調整 */
        .fc-event { cursor: pointer; border: none; padding: 2px 4px; font-size: 0.85rem; border-radius: 3px; }
        .fc-daygrid-day-number { color: #555; font-weight: 500; }
        .fc-col-header-cell-cushion { color: #555; padding: 8px 0; }

        /* AI生成ボタンエリア */
        .action-area {
            position: sticky;
            bottom: 0;
            background: white;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        .cost-display {
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
        }
        .cost-label { font-size: 0.8rem; opacity: 0.8; }
        .cost-value { font-size: 1.8rem; font-weight: bold; margin-top: 5px; }

        /* ★ローディングオーバーレイ */
        #loadingOverlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { font-weight: bold; color: #555; font-size: 1.2rem; }
        .loading-sub { color: #888; font-size: 0.9rem; margin-top: 5px; }

    </style>
</head>
<body>

    <header>
        <h1><i class="fas fa-calendar-check" style="color: var(--primary-color);"></i> Smart Shift <span style="font-weight:300;">Scheduler</span></h1>
        <div style="display: flex; align-items: center; gap: 15px;">
            <span class="subtitle">AI Powered Shift Optimization</span>
            <button onclick="downloadCSV()" class="btn-success" style="padding: 8px 15px; font-size: 0.9rem;">
                <i class="fas fa-file-csv"></i> CSV出力
            </button>
        </div>
    </header>

    <div class="container">
        <div class="sidebar">
            
            <div class="card">
                <h2><i class="fas fa-users"></i> スタッフ管理</h2>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="staffName" placeholder="名前" style="flex:2;">
                    <input type="number" id="staffWage" placeholder="時給" value="1000" style="flex:1;">
                </div>
                <input type="text" id="staffRoles" placeholder="役割 (例: Kitchen, Hall)">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <label style="margin:0; cursor:pointer;"><input type="checkbox" id="isLeader" style="width:auto; margin-right:5px;"> リーダー権限</label>
                    <button onclick="addStaff()" class="btn-primary" style="width:auto; padding:5px 15px;">追加</button>
                </div>
                
                <details>
                    <summary style="cursor:pointer; color:var(--primary-color); font-size:0.85rem; text-align:right;">リストを表示</summary>
                    <table id="staffTable">
                        <thead><tr><th>名前</th><th>時給</th><th>役割</th><th></th></tr></thead>
                        <tbody></tbody>
                    </table>
                </details>
            </div>

            <div class="card">
                <h2><i class="fas fa-calendar-times"></i> 希望休 (NG)</h2>
                <select id="requestStaffSelect"></select>
                <div style="display:flex; gap:5px;">
                    <input type="date" id="requestDate">
                    <button onclick="addRequest()" class="btn-danger" style="width:auto; white-space:nowrap;">登録</button>
                </div>
            </div>

            <div class="card" style="flex:1; display:flex; flex-direction:column;">
                <h2><i class="fas fa-cogs"></i> 生成ルール</h2>
                
                <div class="rule-box">
                    <label style="margin-bottom:8px; display:block;">役割の最低人数:</label>
                    <div style="display:flex; gap:5px; margin-bottom:5px;">
                        <select id="ruleRole" style="flex:1; margin:0;"><option value="">役割...</option></select>
                        <input type="number" id="ruleCount" value="1" min="1" style="width:50px; margin:0;">
                        <button onclick="addRule()" class="btn-secondary" style="width:auto; padding:0 10px;">+</button>
                    </div>
                    <ul id="ruleList" class="rule-list" style="margin:0; padding:0; list-style:none;"></ul>
                </div>

                <div class="rule-box" style="background:#fffde7; border-color:#fff59d;">
                    <label style="margin-bottom:8px; display:block;">日付別の必要人数:</label>
                    <div style="display:flex; gap:5px; margin-bottom:5px;">
                        <input type="date" id="reqDate" style="flex:1; margin:0;">
                    </div>
                    <div style="display:flex; gap:5px; align-items:center;">
                        <span style="font-size:0.8rem;">早番</span><input type="number" id="reqMorning" value="2" min="0" style="width:60px; margin:0;">
                        <span style="font-size:0.8rem;">遅番</span><input type="number" id="reqEvening" value="2" min="0" style="width:60px; margin:0;">
                        <button onclick="addRequirement()" class="btn-success" style="width:auto; padding:0 10px;">+</button>
                    </div>
                    <ul id="reqList" class="rule-list" style="margin:5px 0 0 0; padding:0; list-style:none;"></ul>
                </div>

                <div class="action-area">
                    <label>開始日:</label>
                    <input type="date" id="startDate" style="font-weight:bold;">
                    
                    <button onclick="generateShift()" class="btn-primary" style="padding: 15px; font-size: 1.1rem; box-shadow: 0 4px 6px rgba(74, 144, 226, 0.3);">
                        <i class="fas fa-robot"></i> AIシフト生成
                    </button>

                    <div class="cost-display">
                        <div class="cost-label">今月の予想人件費</div>
                        <div id="totalCost" class="cost-value">¥0</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div id="calendar" class="card" style="height: 100%; border:none; box-shadow:none;"></div>
        </div>
    </div>

    <div id="loadingOverlay">
        <div class="loader"></div>
        <div class="loading-text">AIが最適なシフトを計算中...</div>
        <div class="loading-sub">数千通りの組み合わせから最適解を探しています</div>
    </div>

    <script>
        const API_URL = "http://localhost:8080/api";
        let calendar;
        let staffMap = {}; 
        let activeRules = []; 

        const SHIFT_DEFINITIONS = {
            1: { label: "早番", time: "09:00-18:00", hours: 8, color: "#4a90e2" },
            2: { label: "遅番", time: "18:00-23:00", hours: 5, color: "#27ae60" }
        };

        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('requestDate').value = today;
            document.getElementById('reqDate').value = today;
            
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'ja',
                editable: true,  
                droppable: true,
                height: '100%', // カレンダーを画面いっぱいに
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,listMonth' },
                events: [],
                eventTimeFormat: { hour: '2-digit', minute: '2-digit', meridiem: false },
                
                eventDrop: async function(info) {
                    if (info.event.display === 'background') {
                        alert("設定データは移動できません。削除して再登録してください。");
                        info.revert(); return;
                    }
                    const shiftId = info.event.id;
                    const newDate = info.event.startStr;
                    const staffId = info.event.extendedProps.staffId;

                    // 重複チェック
                    const isDuplicate = calendar.getEvents().some(evt => 
                        evt.id !== info.event.id && evt.startStr === newDate && evt.extendedProps.staffId === staffId && evt.display !== 'background'
                    );
                    if (isDuplicate) {
                        alert("その日には既にシフトが入っています。");
                        info.revert(); return;
                    }

                    try {
                        const res = await fetch(`${API_URL}/shift/${shiftId}`, {
                            method: "PUT",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ date: newDate })
                        });
                        if (!res.ok) throw new Error("保存失敗");
                        calculateTotalCost();
                    } catch (e) { alert(e); info.revert(); }
                },

                eventClick: async function(info) {
                    const type = info.event.extendedProps.type;
                    if (type === 'requirement') return; // 設定はリストから削除
                    
                    const msg = type === 'request' ? "この希望休を取り消しますか？" : "このシフトを削除しますか？";
                    if (confirm(msg)) {
                        try {
                            const endpoint = type === 'request' ? 'request' : 'shift';
                            const res = await fetch(`${API_URL}/${endpoint}/${info.event.id}`, { method: "DELETE" });
                            if (!res.ok) throw new Error("削除失敗");
                            info.event.remove();
                            calculateTotalCost();
                        } catch (e) { alert(e); }
                    }
                },
                datesSet: function() { setTimeout(calculateTotalCost, 100); }
            });
            calendar.render();
            initData();
        });

        async function initData() {
            await loadStaff();          
            await loadExistingShifts(); 
            await loadRequests();
            await loadRequirements();
            calculateTotalCost();
        }

        // --- 人件費計算 ---
        function calculateTotalCost() {
            if (!calendar) return;
            const view = calendar.view;
            const currentStart = view.activeStart;
            const currentEnd = view.activeEnd;
            const events = calendar.getEvents();
            let total = 0;
            events.forEach(evt => {
                if (evt.extendedProps.type !== 'shift') return;
                if (evt.start >= currentStart && evt.start < currentEnd) {
                    total += (evt.extendedProps.wage || 0) * (evt.extendedProps.hours || 0);
                }
            });
            document.getElementById("totalCost").innerText = "¥" + total.toLocaleString();
        }

        // --- データ読み込み系 ---
        async function loadStaff() {
            try {
                const res = await fetch(`${API_URL}/staff`);
                const staffList = await res.json();
                staffMap = {};
                
                const tbody = document.querySelector("#staffTable tbody");
                const staffSelect = document.getElementById("requestStaffSelect");
                const roleSelect = document.getElementById("ruleRole");
                
                tbody.innerHTML = "";
                staffSelect.innerHTML = ""; 
                roleSelect.innerHTML = '<option value="">役割...</option>';
                const allRoles = new Set();

                staffList.forEach(s => {
                    staffMap[s.id] = { name: s.name, wage: s.hourly_wage || 0 };
                    let rolesHtml = "";
                    if (s.roles) {
                        s.roles.split(',').forEach(r => {
                            const rn = r.trim();
                            if(rn) { allRoles.add(rn); rolesHtml += `<span class="badge badge-role">${rn}</span>`; }
                        });
                    }
                    const badge = s.is_leader ? '<span class="badge badge-leader">Leader</span>' : '<span class="badge badge-staff">Staff</span>';
                    
                    tbody.innerHTML += `<tr>
                        <td>${s.name} <div style="font-size:0.8em; color:#999;">${rolesHtml} ${badge}</div></td>
                        <td>¥${s.hourly_wage}</td>
                        <td style="text-align:right;">
                            <button class="btn-icon" onclick="deleteStaff(${s.id})"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>`;
                    
                    const option = document.createElement("option");
                    option.value = s.id;
                    option.text = s.name;
                    staffSelect.appendChild(option);
                });

                allRoles.forEach(r => {
                    const option = document.createElement("option");
                    option.value = r; option.text = r;
                    roleSelect.appendChild(option);
                });
            } catch(e) { console.error(e); }
        }

        async function loadExistingShifts() {
            try {
                const res = await fetch(`${API_URL}/shift`);
                if (!res.ok) return;
                const shifts = await res.json();
                calendar.removeAllEvents(); 
                const events = shifts.map(s => {
                    const staffInfo = staffMap[s.staff_id] || { name: `ID:${s.staff_id}`, wage: 0 };
                    const def = SHIFT_DEFINITIONS[s.shift_type] || { label: "?", time: "", hours: 0, color: "#999" };
                    return {
                        id: s.id, 
                        title: `${def.time} ${staffInfo.name}`, 
                        start: s.date, 
                        color: def.color,
                        extendedProps: { type: 'shift', staffId: s.staff_id, wage: staffInfo.wage, hours: def.hours }
                    };
                });
                calendar.addEventSource(events);
                await loadRequests();
                await loadRequirements();
                calculateTotalCost(); 
            } catch (e) { console.error(e); }
        }

        async function loadRequests() {
            try {
                const res = await fetch(`${API_URL}/request`);
                if (!res.ok) return;
                const reqs = await res.json();
                const events = reqs.map(r => {
                    const staffInfo = staffMap[r.staff_id] || { name: `ID:${r.staff_id}` };
                    return {
                        id: r.id, title: `✕ ${staffInfo.name}`, start: r.date,
                        display: 'background', backgroundColor: '#ffebee', 
                        extendedProps: { type: 'request', staffId: r.staff_id }
                    };
                });
                calendar.addEventSource(events);
            } catch (e) { console.error(e); }
        }

        async function loadRequirements() {
            try {
                const res = await fetch(`${API_URL}/requirement`);
                if (!res.ok) return;
                const list = await res.json();
                
                // カレンダー用
                const existing = calendar.getEvents().filter(e => e.extendedProps.type === 'requirement');
                existing.forEach(e => e.remove());
                const events = list.map(req => ({
                    id: `req-${req.id}`, title: `早${req.morning_need}/遅${req.evening_need}`,
                    start: req.date, display: 'background', backgroundColor: '#fff9c4',
                    extendedProps: { type: 'requirement' }
                }));
                calendar.addEventSource(events);

                // リスト用
                const ul = document.getElementById("reqList");
                if (ul) {
                    ul.innerHTML = "";
                    list.sort((a, b) => new Date(a.date) - new Date(b.date));
                    list.forEach(req => {
                        const li = document.createElement("li");
                        li.innerHTML = `
                            <span>${req.date.slice(5)} : <span class="badge badge-role">早${req.morning_need}</span> <span class="badge badge-role">遅${req.evening_need}</span></span>
                            <button class="btn-icon" onclick="deleteRequirement(${req.id})"><i class="fas fa-trash-alt"></i></button>
                        `;
                        ul.appendChild(li);
                    });
                }
            } catch (e) { console.error(e); }
        }

        // --- アクション ---
        async function addStaff() {
            const name = document.getElementById("staffName").value;
            const wage = document.getElementById("staffWage").value;
            const roles = document.getElementById("staffRoles").value; 
            const isLeader = document.getElementById("isLeader").checked;
            if(!name) return alert("名前を入れてください");
            await fetch(`${API_URL}/staff`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name, is_leader: isLeader, hourly_wage: parseInt(wage), roles: roles })
            });
            document.getElementById("staffName").value = "";
            document.getElementById("staffRoles").value = ""; 
            initData(); 
        }

        async function deleteStaff(id) {
            if(!confirm("削除しますか？")) return;
            await fetch(`${API_URL}/staff/${id}`, { method: "DELETE" });
            initData();
        }

        async function addRequest() {
            const staffId = document.getElementById("requestStaffSelect").value;
            const date = document.getElementById("requestDate").value;
            if(!staffId || !date) return alert("選択してください");
            try {
                const res = await fetch(`${API_URL}/request`, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ staff_id: parseInt(staffId), date: date })
                });
                if(res.ok) { await loadRequests(); } else { alert("登録失敗"); }
            } catch(e) { alert(e); }
        }

        function addRule() {
            const role = document.getElementById("ruleRole").value;
            const count = parseInt(document.getElementById("ruleCount").value);
            if(!role || count <= 0) return;
            activeRules.push({ role, count });
            renderRules();
        }
        function renderRules() {
            const list = document.getElementById("ruleList");
            list.innerHTML = "";
            activeRules.forEach((r, index) => {
                const li = document.createElement("li");
                li.innerHTML = `
                    <span><span class="badge badge-role">${r.role}</span> ${r.count}人以上</span>
                    <button class="btn-icon" onclick="removeRule(${index})"><i class="fas fa-times"></i></button>
                `;
                list.appendChild(li);
            });
        }
        function removeRule(index) { activeRules.splice(index, 1); renderRules(); }

        async function addRequirement() {
            const date = document.getElementById("reqDate").value;
            const morning = parseInt(document.getElementById("reqMorning").value);
            const evening = parseInt(document.getElementById("reqEvening").value);
            if (!date) return;
            try {
                await fetch(`${API_URL}/requirement`, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ date, morning_need: morning, evening_need: evening })
                });
                await loadRequirements();
            } catch(e) { alert(e); }
        }
        async function deleteRequirement(id) {
            if(!confirm("削除しますか？")) return;
            await fetch(`${API_URL}/requirement/${id}`, { method: "DELETE" });
            await loadRequirements();
        }

        function downloadCSV() { window.location.href = `${API_URL}/export`; }

        // ★AI生成（ローディング付き）
        async function generateShift() {
            const startDateStr = document.getElementById("startDate").value;
            if(!startDateStr) return alert("開始日を選んでください");
            
            // ローディング表示
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = 'flex';

            const reqBody = { 
                start_date: startDateStr, 
                days: 30, 
                requests: [], 
                role_constraints: activeRules 
            };

            try {
                const res = await fetch(`${API_URL}/shift`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(reqBody)
                });
                const data = await res.json();
                
                // 少しだけ待機（演出用）
                setTimeout(async () => {
                    overlay.style.display = 'none';
                    if(res.ok) {
                        await initData(); 
                        // 成功のアラートは出さずに、カレンダー更新で完了とする（モダンな挙動）
                    } else { 
                        alert("エラー: " + JSON.stringify(data)); 
                    }
                }, 800);

            } catch (e) { 
                overlay.style.display = 'none';
                alert("エラー: " + e); 
            }
        }
    </script>
</body>
</html>