<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Smart Shift Scheduler</title>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; max-width: 1100px; margin: 0 auto; padding: 20px; background-color: #f4f4f9; color: #333; }
        .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1, h2 { margin-top: 0; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="date"], input[type="number"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background 0.3s; }
        button:hover { background-color: #0056b3; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f8f9fa; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; color: white; }
        .badge-leader { background-color: #28a745; }
        .badge-staff { background-color: #6c757d; }
        
        #calendar { max-width: 1000px; margin: 0 auto; min-height: 700px; }
        .fc-event-title { font-weight: bold; }

        /* ã‚³ã‚¹ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .cost-panel { 
            background-color: #28a745; color: white; 
            padding: 15px; border-radius: 8px; text-align: right; font-size: 1.2em; font-weight: bold;
            margin-bottom: 10px;
        }
        .cost-value { font-size: 1.5em; margin-left: 10px; }
    </style>
</head>
<body>
    <h1>ğŸ“… Smart Shift Scheduler <small>(Ver 2.0)</small></h1>

    <div class="card">
        <h2>1. ã‚¹ã‚¿ãƒƒãƒ•ç™»éŒ²</h2>
        <div class="form-group">
            <label>åå‰</label>
            <input type="text" id="staffName" placeholder="ä¾‹: ä½è—¤" style="width: 150px;">
            
            <label style="display:inline-block; margin-left: 10px;">æ™‚çµ¦ (å††)</label>
            <input type="number" id="staffWage" placeholder="1000" value="1000" style="width: 80px;">

            <label style="display:inline; margin-left: 10px;">
                <input type="checkbox" id="isLeader"> ãƒªãƒ¼ãƒ€ãƒ¼
            </label>
            <button onclick="addStaff()" style="margin-left: 10px;">ç™»éŒ²</button>
        </div>
        <details>
            <summary style="cursor:pointer; color:#007bff;">ç¾åœ¨ã®ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§ã‚’è¡¨ç¤º</summary>
            <table id="staffTable">
                <thead><tr><th>ID</th><th>åå‰</th><th>æ™‚çµ¦</th><th>æ¨©é™</th></tr></thead>
                <tbody></tbody>
            </table>
        </details>
    </div>

    <div class="card">
        <h2>2. ã‚·ãƒ•ãƒˆä½œæˆè¨­å®š</h2>
        <div class="form-group">
            <label>ã‚·ãƒ•ãƒˆé–‹å§‹æ—¥: <input type="date" id="startDate"></label>
            <button onclick="generateShift()">AIã§ã‚·ãƒ•ãƒˆã‚’ç”Ÿæˆãƒ»ä¿å­˜</button>
        </div>
    </div>

    <div class="card">
        <div class="cost-panel">
            æœŸé–“ä¸­ã®æ¨å®šäººä»¶è²»: <span id="totalCost" class="cost-value">Â¥0</span>
        </div>
        <div id="calendar"></div>
    </div>

    <script>
        const API_URL = "http://localhost:8080/api";
        let calendar;
        let staffMap = {}; // ID -> {name, wage} ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›´

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('startDate').valueAsDate = new Date();
            
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'ja',
                editable: true,  
                droppable: true,
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,listMonth'
                },
                events: [],

                eventDrop: async function(info) {
                    // (å¤‰æ›´ãªã—: é‡è¤‡ãƒã‚§ãƒƒã‚¯ã¨æ›´æ–°å‡¦ç†)
                    const shiftId = info.event.id;
                    const newDate = info.event.startStr;
                    const staffId = info.event.extendedProps.staffId;

                    const allEvents = calendar.getEvents();
                    const isDuplicate = allEvents.some(evt => {
                        return evt.id !== info.event.id && 
                               evt.startStr === newDate && 
                               evt.extendedProps.staffId === staffId;
                    });
                    if (isDuplicate) {
                        alert("ã‚¨ãƒ©ãƒ¼ï¼šãã®æ—¥ã«ã¯æ—¢ã«æœ¬äººãŒã‚·ãƒ•ãƒˆã«å…¥ã£ã¦ã„ã¾ã™ï¼");
                        info.revert(); return;
                    }
                    if (!confirm(`${info.event.title} ã‚’ ${newDate} ã«ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ`)) {
                        info.revert(); return;
                    }
                    try {
                        const res = await fetch(`${API_URL}/shift/${shiftId}`, {
                            method: "PUT",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ date: newDate })
                        });
                        if (!res.ok) throw new Error("ä¿å­˜å¤±æ•—");
                        calculateTotalCost(); // â˜…ç§»å‹•ã—ãŸã‚‰ã‚³ã‚¹ãƒˆå†è¨ˆç®—ï¼ˆæœˆã‚’è·¨ãå ´åˆãªã©ã«å‚™ãˆã¦ï¼‰
                    } catch (e) {
                        alert(e); info.revert();
                    }
                },
                eventClick: async function(info) {
                    if (confirm(`${info.event.title} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                        try {
                            const res = await fetch(`${API_URL}/shift/${info.event.id}`, { method: "DELETE" });
                            if (!res.ok) throw new Error("å‰Šé™¤å¤±æ•—");
                            info.event.remove();
                            calculateTotalCost(); // â˜…å‰Šé™¤ã—ãŸã‚‰ã‚³ã‚¹ãƒˆå†è¨ˆç®—
                        } catch (e) { alert(e); }
                    }
                },
                // â˜…è¡¨ç¤ºæœŸé–“ãŒå¤‰ã‚ã£ãŸæ™‚ã«ã‚‚å†è¨ˆç®—ã—ãŸã„ã®ã§è¿½åŠ 
                datesSet: function() {
                    calculateTotalCost();
                }
            });
            calendar.render();
            initData();
        });

        async function initData() {
            await loadStaff();          
            await loadExistingShifts(); 
        }

        async function loadStaff() {
            try {
                const res = await fetch(`${API_URL}/staff`);
                const staffList = await res.json();
                staffMap = {};
                const tbody = document.querySelector("#staffTable tbody");
                tbody.innerHTML = "";
                staffList.forEach(s => {
                    // â˜…æ™‚çµ¦æƒ…å ±ã‚‚ä¿å­˜
                    staffMap[s.id] = { name: s.name, wage: s.hourly_wage || 0 };

                    const badge = s.is_leader ? '<span class="badge badge-leader">Leader</span>' : '<span class="badge badge-staff">Staff</span>';
                    tbody.innerHTML += `<tr><td>${s.id}</td><td>${s.name}</td><td>Â¥${s.hourly_wage}</td><td>${badge}</td></tr>`;
                });
            } catch(e) { console.error(e); }
        }

        async function loadExistingShifts() {
            try {
                const res = await fetch(`${API_URL}/shift`);
                if (!res.ok) return;
                const shifts = await res.json();
                
                const events = shifts.map(s => {
                    const staffInfo = staffMap[s.staff_id] || { name: `ID:${s.staff_id}`, wage: 0 };
                    
                    let title = `${staffInfo.name} `; 
                    let color = "";
                    let hours = 0;

                    if (s.shift_type === 1) { 
                        title += "æ—©(09-18)"; 
                        color = "#3788d8"; 
                        hours = 8; // ä¼‘æ†©1æ™‚é–“å¼•ã„ã¦8æ™‚é–“åŠ´åƒã¨ä»®å®š
                    } else if (s.shift_type === 2) { 
                        title += "é…(13-22)"; 
                        color = "#28a745"; 
                        hours = 8;
                    }
                    
                    return {
                        id: s.id,
                        title: title,
                        start: s.date,
                        color: color,
                        extendedProps: { 
                            staffId: s.staff_id,
                            wage: staffInfo.wage, // â˜…ã‚¤ãƒ™ãƒ³ãƒˆã«æ™‚çµ¦ã¨æ™‚é–“ã‚’åŸ‹ã‚è¾¼ã‚€
                            hours: hours
                        }
                    };
                });

                calendar.removeAllEvents();
                calendar.addEventSource(events);
                
                // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¾Œã«è¨ˆç®—
                calculateTotalCost();

            } catch (e) { console.error("ã‚·ãƒ•ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e); }
        }

        // â˜…äººä»¶è²»è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
        function calculateTotalCost() {
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å…¨ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
            const events = calendar.getEvents();
            let total = 0;

            events.forEach(evt => {
                const wage = evt.extendedProps.wage || 0;
                const hours = evt.extendedProps.hours || 0;
                total += wage * hours;
            });

            // 3æ¡åŒºåˆ‡ã‚Šã§è¡¨ç¤º
            document.getElementById("totalCost").innerText = "Â¥" + total.toLocaleString();
        }

        async function addStaff() {
            const name = document.getElementById("staffName").value;
            const wage = document.getElementById("staffWage").value; // â˜…æ™‚çµ¦å–å¾—
            const isLeader = document.getElementById("isLeader").checked;
            
            if(!name) return alert("åå‰ã‚’å…¥ã‚Œã¦ãã ã•ã„");

            await fetch(`${API_URL}/staff`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    name, 
                    is_leader: isLeader,
                    hourly_wage: parseInt(wage) // â˜…æ•°å€¤ã¨ã—ã¦é€ä¿¡
                })
            });
            document.getElementById("staffName").value = "";
            initData(); 
        }

        async function generateShift() {
            const startDateStr = document.getElementById("startDate").value;
            if(!startDateStr) return alert("é–‹å§‹æ—¥ã‚’é¸ã‚“ã§ãã ã•ã„");

            const reqBody = {
                start_date: startDateStr,
                days: 30, 
                requests: [],
                requirements: [] 
            };
            alert("AIãŒè¨ˆç®—ãƒ»ä¿å­˜ä¸­ã§ã™...");
            try {
                const res = await fetch(`${API_URL}/shift`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(reqBody)
                });
                const data = await res.json();
                if(res.ok) {
                    await loadExistingShifts(); 
                    alert(data.message);
                } else {
                    alert("ã‚¨ãƒ©ãƒ¼: " + JSON.stringify(data));
                }
            } catch (e) { alert("ã‚¨ãƒ©ãƒ¼: " + e); }
        }
    </script>
</body>
</html>